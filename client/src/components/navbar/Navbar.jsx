import { NavLink } from "react-router-dom";
import { useEffect, useState } from "react";
import "/src/components/navbar/Navbar.css";

const API_BASE = "https://newsproject-dx8n.onrender.com";

function firstNumber(...vals) {
  for (const v of vals) if (typeof v === "number" && Number.isFinite(v)) return v;
  return 0;
}

export default function Navbar() {
  const [localsCount, setLocalsCount] = useState(0);

  useEffect(() => {
    const token = localStorage.getItem("token");
    if (!token) return;

    (async () => {
      try {
        const r = await fetch(`${API_BASE}/api/requests`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await r.json();
        const requests = Array.isArray(data?.requests) ? data.requests : [];

        // пробуем посчитать по полям, если бек их отдаёт
        let baseSum = 0;
        for (const req of requests) {
          baseSum += firstNumber(
            req.messages_cnt,
            req.responses_cnt,
            req.responses_count,
            Array.isArray(req.responses) ? req.responses.length : undefined
          );
        }
        if (baseSum > 0) {
          setLocalsCount(baseSum);
          return;
        }

        // иначе дотягиваем по каждой заявке /responses
        const arrays = await Promise.all(
          requests.map(async (req) => {
            try {
              const rr = await fetch(`${API_BASE}/api/requests/${req.id}/responses`, {
                headers: { Authorization: `Bearer ${token}` },
              });
              if (!rr.ok) return [];
              const json = await rr.json();
              return Array.isArray(json?.responses) ? json.responses : [];
            } catch {
              return [];
            }
          })
        );
        const total = arrays.reduce((acc, arr) => acc + arr.length, 0);
        setLocalsCount(total);
      } catch {
        setLocalsCount(0);
      }
    })();
  }, []);

  return (
    <nav className="navbar">
      <NavLink to="/" className={({ isActive }) => `nav-item ${isActive ? "active" : ""}`}>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M20.4 22.7998H14.6001C14.2819 22.7998 13.9766 22.6734 13.7516 22.4484C13.5266 22.2233 13.4001 21.9181 13.4001 21.5999V18C13.4001 17.6817 13.2737 17.3765 13.0487 17.1515C12.8236 16.9265 12.5184 16.8 12.2001 16.8H11.8002C11.4819 16.8 11.1767 16.9265 10.9517 17.1515C10.7266 17.3765 10.6002 17.6817 10.6002 18V21.5999C10.6002 21.9181 10.4738 22.2233 10.2487 22.4484C10.0237 22.6734 9.71847 22.7998 9.40022 22.7998H3.60029C3.28203 22.7998 2.97681 22.6734 2.75177 22.4484C2.52673 22.2233 2.40031 21.9181 2.40031 21.5999V9.86425C2.40031 9.546 2.52673 9.24078 2.75177 9.01575C2.97681 8.79071 3.28203 8.66429 3.60029 8.66429C3.91854 8.66429 4.22376 8.79071 4.4488 9.01575C4.67384 9.24078 4.80027 9.546 4.80027 9.86425V20.3999H8.20024V18C8.20024 17.0452 8.57951 16.1296 9.25463 15.4545C9.92976 14.7794 10.8454 14.4001 11.8002 14.4001H12.2001C13.1549 14.4001 14.0706 14.7794 14.7457 15.4545C15.4208 16.1296 15.8001 17.0452 15.8001 18V20.3999H19.2001V9.86425C19.2001 9.546 19.3265 9.24078 19.5515 9.01575C19.7766 8.79071 20.0818 8.66429 20.4 8.66429C20.7183 8.66429 21.0235 8.79071 21.2486 9.01575C21.4736 9.24078 21.6 9.546 21.6 9.86425V21.5999C21.6 21.9181 21.4736 22.2233 21.2486 22.4484C21.0235 22.6734 20.7183 22.7998 20.4 22.7998Z" />
          <path d="M22.7998 13.1998C22.5056 13.1998 22.2216 13.0918 22.0018 12.8962L12 4.00565L1.99811 12.8962C1.8804 13.001 1.74319 13.0815 1.59434 13.1333C1.44548 13.1851 1.28788 13.207 1.13054 13.1979C0.973207 13.1888 0.819211 13.1487 0.677346 13.0801C0.535482 13.0114 0.408529 12.9155 0.303736 12.7978C0.198943 12.6801 0.118361 12.5429 0.0665925 12.394C0.0148237 12.2452 -0.00711845 12.0876 0.0020187 11.9302C0.0111559 11.7729 0.0511933 11.6189 0.119845 11.477C0.188497 11.3352 0.284419 11.2082 0.402135 11.1034L11.202 1.50373C11.4217 1.30806 11.7057 1.19995 12 1.19995C12.2942 1.19995 12.5782 1.30806 12.798 1.50373L23.5978 11.1034C23.7795 11.2652 23.9078 11.4783 23.9656 11.7147C24.0234 11.951 24.0081 12.1993 23.9215 12.4267C23.8349 12.6541 23.6813 12.8498 23.481 12.9878C23.2807 13.1259 23.0431 13.1998 22.7998 13.1998Z" />
        </svg>
        <span>Главная</span>
      </NavLink>

      <NavLink
        to="/c/sos"
        state={{ slug: "sos" }}
        className={({ isActive }) => `nav-item ${isActive ? "active" : ""}`}
      >
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path fillRule="evenodd" clipRule="evenodd" d="M8.45876 19.269H6.63379L7.83731 9.26385C7.91358 8.66861 7.91947 8.19283 8.22083 7.78299C8.47107 7.44268 8.9322 7.1669 9.52106 7.1669H14.3423C14.8276 7.1669 15.2482 7.36963 15.5178 7.69235C15.5837 7.77115 15.7216 7.95225 15.7314 8.06728C15.6033 8.00751 15.2765 7.96136 15.0777 7.96136H11.0464C10.5383 7.96136 10.0938 8.2561 9.89632 8.56452C9.65119 8.94734 9.64829 9.45027 9.58057 9.97885C9.44998 10.9981 9.34555 12.1102 9.20616 13.084C9.02907 14.321 8.9187 15.6971 8.74311 16.9238L8.45876 19.269ZM3.61035 20.0105V21.7583C3.61035 22.1744 3.96888 22.4998 4.40027 22.4998H19.4358C19.8838 22.4998 20.2257 22.1674 20.2257 21.7318V20.037C20.2257 19.667 19.9899 19.4075 19.6967 19.3067C19.2645 19.1582 18.9331 19.4201 18.8884 19.1657C18.8717 19.0707 18.8705 18.9886 18.8555 18.8799C18.6082 17.0809 18.4115 15.0734 18.1639 13.2761L17.8855 11.031C17.805 10.3539 17.5826 8.24374 17.4075 7.73535C17.2497 7.27724 17.0067 6.8993 16.6913 6.5514C16.5786 6.42704 16.4758 6.3556 16.3509 6.24685C15.9691 5.91445 15.1933 5.55151 14.4784 5.55151H9.41211C9.0351 5.55151 8.63669 5.66501 8.35369 5.76714C7.75945 5.98159 7.28718 6.36853 6.9021 6.84516C6.24356 7.66025 6.21527 8.79369 6.09132 9.84379C6.00201 10.6005 5.90411 11.3355 5.81433 12.0903L4.98015 18.8265C4.96806 18.9206 4.95803 19.0223 4.95137 19.0898C4.93669 19.2384 4.97887 19.2653 4.81229 19.2724C4.60247 19.2814 4.3492 19.2471 4.18073 19.294C3.87745 19.3783 3.61035 19.6375 3.61035 20.0105Z" />
          <path fillRule="evenodd" clipRule="evenodd" d="M1.10449 12.8075C1.10449 13.2799 1.48398 13.6284 1.97613 13.6284C2.25657 13.6284 3.18387 13.1208 3.48331 12.9752L4.22613 12.6381C4.57765 12.4329 4.70991 12.0135 4.55355 11.6258C4.41104 11.2724 4.07977 11.1392 3.69214 11.1392C3.39675 11.1392 2.464 11.6435 2.19402 11.7747C1.72867 12.0009 1.10449 12.1745 1.10449 12.8075Z" />
          <path fillRule="evenodd" clipRule="evenodd" d="M19.3813 7.14038C19.3813 7.49011 19.5818 7.77745 19.8709 7.90903C20.2956 8.10228 20.641 7.8786 20.9975 7.70532L22.1052 7.16685C22.417 7.01479 22.8951 6.89796 22.8951 6.29297C22.8951 5.881 22.5687 5.5565 22.2101 5.50119C21.7325 5.42753 21.0843 5.83587 20.5798 6.08111C20.2502 6.24133 19.8638 6.36382 19.6053 6.61667C19.4875 6.73189 19.3813 6.91969 19.3813 7.14038Z" />
          <path fillRule="evenodd" clipRule="evenodd" d="M19.354 11.9071C19.354 12.6167 19.7452 12.6931 20.4163 13.0194C20.7481 13.1807 21.5408 13.6285 21.8872 13.6285C22.7205 13.6285 23.0223 12.5739 22.3727 12.1501C22.1518 12.0061 21.3077 11.6122 21.0065 11.4658C20.6012 11.2688 20.5393 11.1921 20.0894 11.1921C19.7384 11.1921 19.354 11.5659 19.354 11.9071Z" />
          <path fillRule="evenodd" clipRule="evenodd" d="M1.10449 6.38654C1.11016 6.64482 1.16133 6.87221 1.53132 7.06967C1.75465 7.18883 1.97321 7.2846 2.20311 7.39636C2.43184 7.50754 2.62814 7.60297 2.85683 7.71414C3.28776 7.92362 3.71451 8.18853 4.20378 7.74374C4.50683 7.46823 4.54146 6.93702 4.25815 6.64306C4.09735 6.47621 4.05574 6.46967 3.83741 6.36357L2.42104 5.67503C2.224 5.57867 2.1208 5.52572 1.88647 5.54342C1.63257 5.56259 1.50844 5.59751 1.36923 5.7294C1.25224 5.84026 1.10449 5.976 1.10449 6.18704V6.38654Z" />
          <path fillRule="evenodd" clipRule="evenodd" d="M6.08936 2.26773C6.08936 2.62079 6.22896 2.77752 6.37989 3.071L7.07682 4.40604C7.52254 5.01547 8.59528 4.80769 8.59528 3.88311C8.59528 3.61358 8.13103 2.82152 7.98695 2.54138C7.79783 2.17363 7.57227 1.49976 7.0427 1.49976C6.7712 1.49976 6.54958 1.51337 6.32646 1.73028C6.20858 1.8449 6.08936 2.04717 6.08936 2.26773Z" />
          <path fillRule="evenodd" clipRule="evenodd" d="M15.2413 3.83015C15.2413 4.05847 15.2203 4.12881 15.3312 4.32537C15.4701 4.5713 15.753 4.75701 16.0313 4.75701C16.7044 4.75701 16.873 4.20609 17.1026 3.75952C17.2748 3.42472 17.7473 2.63783 17.7473 2.2942C17.7473 1.82683 17.3639 1.52216 16.9523 1.49976H16.8545C16.6207 1.51268 16.387 1.6187 16.2171 1.8393L15.541 3.14163C15.4677 3.28413 15.2413 3.65969 15.2413 3.83015Z" />
        </svg>
        <span>Помощь</span>
      </NavLink>

      <NavLink to="/application" className={({ isActive }) => `nav-item ${isActive ? "active" : ""}`}>
        <svg width="28" height="28" viewBox="0 0 28 28" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <g opacity="0.75">
            <path d="M8.83729 13.3553C8.12515 13.3553 7.54782 12.7779 7.54782 12.0658C7.54782 11.3536 8.12515 10.7763 8.83729 10.7763H19.1531C19.8653 10.7763 20.4426 11.3536 20.4426 12.0658C20.4426 12.7779 19.8653 13.3553 19.1531 13.3553H8.83729ZM8.83729 18.5132C8.12515 18.5132 7.54782 17.9359 7.54782 17.2237C7.54782 16.5115 8.12515 15.9342 8.83729 15.9342H12.7057C13.4179 15.9342 13.9952 16.5115 13.9952 17.9359C13.9952 17.9359 13.4179 18.5132 12.7057 18.5132H8.83729ZM26.895 14C26.895 17.5607 25.4517 20.7844 23.1181 23.1179C20.7846 25.4515 17.5609 26.8948 14.0002 26.8948H2.39587C1.68373 26.8948 1.10639 26.3175 1.10639 25.6053C1.10639 25.3944 1.15703 25.1953 1.24681 25.0196C1.50645 24.3781 2.9446 20.7265 2.44831 19.7281C2.01188 18.8501 1.67294 17.918 1.44555 16.946C1.22312 15.9951 1.10547 15.0087 1.10547 14C1.10547 10.4393 2.5488 7.21565 4.88236 4.88212C7.21589 2.54856 10.4396 1.10522 14.0002 1.10522C17.5609 1.10522 20.7846 2.54856 23.1181 4.8821C25.4517 7.21563 26.895 10.4393 26.895 14ZM21.2947 21.2945C23.1614 19.4278 24.3161 16.8488 24.3161 14C24.3161 11.1512 23.1614 8.57224 21.2947 6.70553C19.428 4.8388 16.849 3.68419 14.0002 3.68419C11.1515 3.68419 8.5725 4.8388 6.70579 6.70554C4.83905 8.57225 3.68444 11.1512 3.68444 14C3.68444 14.8175 3.77769 15.608 3.954 16.3617C4.13716 17.1447 4.40797 17.891 4.75528 18.5897C5.42595 19.939 4.79075 22.5571 4.22649 24.3158H14.0002C16.849 24.3158 19.428 23.1612 21.2947 21.2945Z" />
          </g>
        </svg>
        {localsCount > 0 && <span className="nav-badge">{localsCount}</span>}
        <span>Местные</span>
      </NavLink>

      <NavLink to="/navigator" className={({ isActive }) => `nav-item ${isActive ? "active" : ""}`}>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path fillRule="evenodd" clipRule="evenodd" d="M2.43165 12.0898C2.43165 10.389 2.84021 8.68454 3.68687 7.28062C4.03262 6.70732 4.45603 6.03496 4.93593 5.56484C5.22856 5.27816 5.06524 5.37578 5.38285 5.11332C5.44838 5.05914 5.48341 5.01902 5.54258 4.9586C7.07035 3.39936 9.75891 2.43165 11.9102 2.43165C13.611 2.43165 15.3155 2.84021 16.7194 3.68687C17.377 4.08345 17.5175 4.1545 18.1233 4.66384C18.3586 4.86168 18.6925 5.14789 18.8867 5.38285C19.0769 5.61304 19.2983 5.79553 19.5791 6.17286L20.2798 7.22408C20.4436 7.49775 20.5541 7.72425 20.7004 8.01637C21.5445 9.70222 21.8151 12.2206 21.3171 14.1745C20.9236 15.7183 20.3443 16.9243 19.3362 18.1233L18.6172 18.8867C18.387 19.0769 18.2045 19.2983 17.8271 19.5791C16.0881 20.8734 14.3015 21.5684 11.9102 21.5684C9.6863 21.5684 7.54033 20.7349 5.87672 19.3362L5.23207 18.7679C4.6675 18.2034 4.13118 17.4629 3.72017 16.7759C2.95731 15.5009 2.43165 13.8391 2.43165 12.0898ZM11.5024 0.5H12.3366C13.3226 0.53748 14.3189 0.706347 15.3691 0.994134C15.5523 1.04432 15.6918 1.0906 15.8807 1.15645C17.0278 1.55635 18.0715 2.17726 19.0331 2.90052C19.8832 3.53999 20.8395 4.5295 21.4242 5.40585L21.712 5.83684C21.9633 6.22866 22.2725 6.74297 22.4478 7.1674C22.5914 7.51493 22.7299 7.78597 22.8547 8.15309C23.2487 9.31163 23.4579 10.4081 23.5 11.5024V12.3366C23.4625 13.3226 23.2937 14.3189 23.0059 15.3691C22.7109 16.4455 22.2423 17.2926 21.6775 18.2185C21.419 18.6422 21.1046 19.0265 20.7984 19.4058C20.664 19.5724 20.597 19.63 20.456 19.7822C20.3317 19.9163 20.282 20.003 20.1425 20.1425C19.9976 20.2874 19.897 20.3452 19.7594 20.4781C19.217 21.0019 18.4205 21.5856 17.7478 21.9704C17.1801 22.2951 16.4757 22.6409 15.8469 22.8547C15.5111 22.9689 15.1006 23.1066 14.7742 23.1745C13.3797 23.4646 13.1444 23.5 11.6856 23.5C8.95839 23.5 6.21061 22.3022 4.21784 20.456C4.08369 20.3317 3.99698 20.282 3.8575 20.1425C3.25957 19.5445 2.46744 18.5132 2.02959 17.7478C1.53548 16.884 1.02952 15.7552 0.82545 14.7742C0.535363 13.3797 0.5 13.1444 0.5 11.6856C0.5 10.7399 0.662215 9.98153 0.833082 9.18856C1.09428 7.97648 1.68494 6.82663 2.3225 5.78148C2.42794 5.60865 2.48625 5.54143 2.59352 5.37868C2.71209 5.1988 2.77633 5.13204 2.90052 4.96693C3.01475 4.81507 3.09219 4.72971 3.2016 4.59418L3.8575 3.8575C4.98827 2.72675 6.64232 1.65907 8.15309 1.14528C9.31163 0.751275 10.4081 0.542066 11.5024 0.5Z" />
          <path fillRule="evenodd" clipRule="evenodd" d="M11.0566 12.0449C11.0566 10.7274 12.9434 10.7274 12.9434 12.0449C12.9434 13.2225 11.0566 13.2225 11.0566 12.0449ZM5.75586 17.7949C5.75586 18.0208 5.97923 18.2442 6.20508 18.2442C6.56129 18.2442 9.88646 16.4933 10.278 16.2975C10.4701 16.2015 14.0916 14.4261 14.2588 14.2588C14.3742 14.1435 15.2029 12.4673 15.2943 12.2845L17.7949 7.2832C17.911 7.05105 18.2442 6.49094 18.2442 6.20508C18.2442 5.97923 18.0208 5.75586 17.7949 5.75586C17.5106 5.75586 16.9893 6.06886 16.7467 6.1901L10.7272 9.19987C10.5334 9.29679 10.4111 9.35646 10.2291 9.46543C9.52702 9.88568 9.89573 9.48928 9.48239 10.2011C9.38607 10.367 9.30511 10.5166 9.21485 10.6973L6.69922 15.7285C6.51849 16.09 5.75586 17.489 5.75586 17.7949Z" />
        </svg>
        <span>Карты</span>
      </NavLink>

      <NavLink to="/account" className={({ isActive }) => `nav-item ${isActive ? "active" : ""}`}>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path fillRule="evenodd" clipRule="evenodd" d="M12 14.75C18.5 14.75 23 16.5925 23 20.25V22C23 22.5523 22.5523 23 22 23H2C1.44772 23 1 22.5523 1 22V20.25C1 16.5925 5.5 14.75 12 14.75ZM12 17.5C6.02547 17.5 4.33106 18.9869 3.85059 19.9961C3.79243 20.1183 3.8882 20.2497 4.02344 20.25H19.9863C20.1187 20.2497 20.2136 20.1236 20.1592 20.0029C19.7078 19.0025 17.9822 17.5 12 17.5Z" />
          <path fillRule="evenodd" clipRule="evenodd" d="M12 1C15.0387 1 17.5 3.46125 17.5 6.5C17.5 9.53875 15.0387 12 12 12C8.96125 12 6.5 9.53875 6.5 6.5C6.5 3.46125 8.96125 1 12 1ZM12 3.75C10.4875 3.75 9.25 4.9875 9.25 6.5C9.25 8.0125 10.4875 9.25 12 9.25C13.5125 9.25 14.75 8.0125 14.75 6.5C14.75 4.9875 13.5125 3.75 12 3.75Z" />
        </svg>
        <span>Аккаунт</span>
      </NavLink>
    </nav>
  );
}
